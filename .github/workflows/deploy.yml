name: Deploy to EC2

on:
  push:
    branches:
      - main # ğŸ”§ ë°°í¬ì— ì‚¬ìš©í•  ê¸°ë³¸ ë¸Œëœì¹˜ (í•„ìš”ì‹œ ë‹¤ë¥¸ ë¸Œëœì¹˜ ì¶”ê°€)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. SSH í‚¤ ì„¤ì •
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }} # ğŸ”§ GitHub Secretsì— ì €ì¥ëœ SSH í‚¤ ì‚¬ìš©

      # 3. EC2 ì„œë²„ì— ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to EC2
        env:
          PROJECT_NAME: your-app-name # ğŸ”§ ë°°í¬í•  í”„ë¡œì íŠ¸ ì´ë¦„ (ì˜ˆ: my-app)
          DEPLOY_DIR: /home/ec2-user/your-app-dir # ğŸ”§ EC2 ì„œë²„ì—ì„œ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ (ì˜ˆ: /home/ec2-user/my-app)
          BRANCH: ${{ github.ref_name }} # í‘¸ì‹œëœ ë¸Œëœì¹˜ ìë™ ê°ì§€ (í•„ìš” ì‹œ ê³ ì •ê°’ ì„¤ì • ê°€ëŠ¥)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd $DEPLOY_DIR
          git pull origin $BRANCH          # ğŸ”§ í•„ìš”ì‹œ originê³¼ BRANCHë¥¼ ê³ ì •ê°’ìœ¼ë¡œ ë³€ê²½
          yarn install --frozen-lockfile
          yarn build 
          pm2 restart $PROJECT_NAME || pm2 start dist/main.js --name $PROJECT_NAME
          EOF
